<!-- 重点参数：renderOptions -->
<!doctype html>
<html lang="zh-CN">

<head>
  <!-- 原始地址：//webapi.amap.com/ui/1.0/ui/misc/PathSimplifier/examples/index.html -->
  <!--<base href="//webapi.amap.com/ui/1.0/ui/misc/PathSimplifier/examples/"/>-->
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>轨迹展示&巡航</title>
  <style>
    html,
    body,
    #container {
      width: 100%;
      height: 100%;
      margin: 0px;
    }

    #loadingTip {
      position: absolute;
      z-index: 9999;
      top: 0;
      left: 0;
      padding: 3px 10px;
      background: red;
      color: #fff;
      font-size: 14px;
    }
  </style>
</head>

<body>
<div id="container"></div>
<script type="text/javascript"
        src='//webapi.amap.com/maps?v=1.4.2&key=dff38aa9299fe308a8a106d8a1e3312f'></script>
<!-- UI组件库 1.0 -->
<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
<script src="/js/map/coordtransform.js"></script>
<script type="text/javascript">
  //创建地图
  var map = new AMap.Map('container', {
    zoom: 10
  });

  AMapUI.load(['ui/misc/PathSimplifier', 'lib/$'], function (PathSimplifier, $) {

    if (!PathSimplifier.supportCanvas) {
      alert('当前环境不支持 Canvas！');
      return;
    }

    //just some colors
    var colors = ["#66aa00"];

    var pathSimplifierIns = new PathSimplifier({
      zIndex: 100,
      //autoSetFitView:false,
      map: map, //所属的地图实例

      getPath: function (pathData, pathIndex) {

        return pathData.path;
      },
      getHoverTitle: function (pathData, pathIndex, pointIndex) {

        if (pointIndex >= 0) {
          //point
          return pathData.name + '，点：' + pointIndex + '/' + pathData.path.length;
        }

        return pathData.name + '，点数量' + pathData.path.length;
      },
      renderOptions: {
        pathLineStyle: {
          dirArrowStyle: true
        },
        getPathStyle: function (pathItem, zoom) {

          var color = colors[0],
              lineWidth = Math.round(4 * Math.pow(1.1, zoom - 3));

          return {
            pathLineStyle: {
              strokeStyle: color,
              lineWidth: lineWidth
            },
            pathLineSelectedStyle: {
              lineWidth: lineWidth + 2
            },
            pathNavigatorStyle: {
              fillStyle: color
            }
          };
        }
      }
    });

    window.pathSimplifierIns = pathSimplifierIns;

    $('<div id="loadingTip">加载数据，请稍候...</div>').appendTo(document.body);

    var navg, total, page_no = 1, page_size = 100, hasMore = true, isFirstLoad = true;
    var pathObjectArray = [];
    var pathObject = {};
    //设置name
    pathObject.name = '车辆行驶轨迹';

    loadData();

    function loadData() {
      $.getJSON(
          'http://192.168.3.148:12006/carhistory/states?order=asc&query_fields=latitude,longitude',
          {
            cs_number: 'cs_number',
            start_time: '2017-07-01 00:00:00',
            end_time: '2017-07-30 00:00:00',
            page_no: page_no,
            page_size: page_size
          },
          function (d) {

            $('#loadingTip').remove();

            if (100000 !== d.code) {
//              alert("数据请求异常！")
              console.log("数据请求异常！")
              return;
            }

            if (d.data.carStateList.length === 0) {
//              alert("已经没有更多数据！")
              console.log("已经没有更多数据！")
              return;
            }

            // 判断是否还有更多数据
            total = d.data.total;
            if (page_no * page_size >= total) {
              hasMore = false;
            }

            var pathRoutes = [];
            var item
            for (var i = 0, len = d.data.carStateList.length; i < len; i++) {
              item = d.data.carStateList[i];
              if (typeof(item.longitude) !== 'undefined' && typeof(item.latitude) !== 'undefined'
                  && item.longitude !== null && item.latitude !== null && item.longitude > 0
                  && item.latitude > 0) {
                pathRoutes.push(coordtransform.wgs84togcj02(item.longitude, item.latitude));
              }
            }
            if (pathRoutes.length === 0) {
//              alert("没有更多GPS数据！");
              console.log("没有更多GPS数据！");
              return;
            }

            if (isFirstLoad) {
              //设置path数组
              pathObject.path = pathRoutes;
              //当前仅有1条轨迹信息
              pathObjectArray.push(pathObject);

              pathSimplifierIns.setData(pathObjectArray);

              //initRoutesContainer(d);

              //创建一个巡航器
              navg = pathSimplifierIns.createPathNavigator(0, {
//              loop: true,
                speed: 1000,
                pathNavigatorStyle: {
                  width: 16,
                  height: 32,
                  content: PathSimplifier.Render.Canvas.getImageContent('/img/car.png', onload,
                      onerror),
                  strokeStyle: null,
                  fillStyle: null,
                  //经过路径的样式
                  pathLinePassedStyle: {
                    lineWidth: 6,
                    strokeStyle: 'blue',
                    dirArrowStyle: {
                      stepSpace: 15,
                      strokeStyle: 'red'
                    }
                  }
                }
              });

              navg.start();

            } else {
              isFirstLoad = false;

              var cursor = navg.getCursor().clone(), //保存巡航器的位置
                  status = navg.getNaviStatus();

              pathObjectArray[0].path = pathRoutes;
              pathSimplifierIns.setData(pathObjectArray); //延展路径

              //重新建立一个巡航器
              navg = pathSimplifierIns.createPathNavigator(0, {
                //loop: true, //循环播放
                speed: 1000 //巡航速度，单位千米/小时
              });

              if (status !== 'stop') {
                navg.start();
              }

              //恢复巡航器的位置
              if (cursor.idx >= 0) {
                navg.moveToPoint(cursor.idx, cursor.tail);
              }
            }
          }
      );
    }

    function onload() {
      pathSimplifierIns.renderLater();
    }

    function onerror(e) {
      alert('图片加载失败！');
    }

    /**
     * 5 秒检查一次轨迹是否完成
     */
    function expandPath() {

      function doExpand() {

        if (!hasMore) {
          return false;
        }

        loadData();

        return true;
      }

      if (doExpand()) {
        setTimeout(expandPath, 1000);
      }
    }

    expandPath();
  });
</script>
</body>

</html>